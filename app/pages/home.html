<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS_System</title>
  </head>
  <body>
    <h1>Hello !</h1>
    <button id="testClick">TestClick!</button>

    <nav>
      <ul>
        <li id="homePageLink">
          <a href="/">Home Page</a>
        </li>
        <li id="createArticleItem" class="hide">
          <a href="/article/create">Create Article</a>
        </li>
        <li id="signupItem">
          <a href="/signup">Sign Up</a>
        </li>
        <li id="signinItem" class="testClass">
          <a href="/signin">Sign In</a>
        </li>
        <li id="signoutItem" class="hide">
          <button id="signoutButton"><a href="/">Sign Out</a></button>
        </li>
      </ul>
    </nav>
    <div class="articles" id="articlesDiv"></div>
    <script>
      // async event handler for window global object onload event
      window.onload = async (e) => {
        // get div with id = `articlesDiv` which should contain
        // the articles that are shown on the home page
        const articlesDiv = document.getElementById("articlesDiv");
        // async event handler for an event, when the area with id = `articlesDiv`
        // get clicked
        articlesDiv.onclick = async (e) => {
          console.log("articlesDiv clicked!: ", e);
        };

        // send request to fetch articles from mongoDB. This request also triggers controller and correspoding method
        // using router implementation in app.js file in the `initialize routes for the application`-section
        fetch("/articles", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          // after we got an answer from server, we should handle it. Since fetch is async process,
          // we can do it with `async,await`-constructionor with `.then`-construction.
          // The answer from the srver is in the `res` variable.
          .then(async (res) => {
            // convert res variable to json format
            const resData = await res.json();
            // if resData exists
            if (!!resData) {
              // save all articles in browser local storage to have the possibility
              // to acces them later when necessary without additional request to server
              localStorage.setItem("articles", JSON.stringify(resData));
              console.log("data in home page: ", resData);
              console.log(Array.from(resData));
              // prepare arra to store formatted articles
              const articles = [];

              // formating each article which is contained in `resData` array
              // to the desired layout format
              resData.forEach((article) => {
                console.log(article);
                article = `
              <div class="article" id="${article._id}">
                  <strong>
                    <a href="/article/${article._id}">
                      ${article.title}
                    </a>
                  </strong>
                  <br />
                  <p>${article.content}</p>
              </div>
              `;
                articles.push(article);
              });
              // Make a string from formated articles array with `join() function` and insert this string
              // into DOM element which is saved in `articlesDiv` variable
              articlesDiv.innerHTML = articles.join("");
            } else if (resData.message) {
              // if backend send error message, show this message in console
              console.log("error in Home Page page: ", resData.message);
              // show alert/toast message or validation hints under inputs with purpose to try again
            }
          });

        // get needed dom elements and save them into variables
        const signupItem = document.getElementById("signupItem");
        const signinItem = document.getElementById("signinItem");
        const signoutButton = document.getElementById("signoutButton");
        const signoutItem = document.getElementById("signoutItem");
        const createArticleItem = document.getElementById("createArticleItem");

        // get needed data and it them into variables
        const user = localStorage.getItem("userId");
        const articles = localStorage.getItem("articles");
        console.log(user);

        // check for user
        if (user) {
          // If user exists in local storage, it means that he is signed in.
          // Thats why we remove `hide`-class and make visible the elements
          // which are allowed to user: `signout`-button  and `create article`-page
          signoutItem.classList.remove("hide");
          createArticleItem.classList.remove("hide");

          signupItem.classList.add("hide");
          signinItem.classList.add("hide");

          // Handler for case if signout button is clicked
          signoutButton.onclick = async (e) => {
            console.log("signed out!", e);
            // Remove user form local storage to implement
            // Sign out process
            localStorage.removeItem("userId");
            console.log(signoutItem.classList);
            // Hide signout button and create article page
            // by adding `hide` class to elements
            signoutItem.classList.add("hide");
            createArticleItem.classList.add("hide");

            signupItem.classList.remove("hide");
            signinItem.classList.remove("hide");
          };
        } else {
          // If no user in the local storage, then we should
          // hide signout button and create article page
          // by adding `hide` class to elements
          signoutItem.classList.add("hide");
          createArticleItem.classList.add("hide");
        }

        // if (articles) {
        //   // transform each article in template with variables
        //   // <div class="article" id ="article + ${article.id}">
        //   //   <strong>${article.title}</strong>
        //   //   <strong>${article.author}</strong>
        //   //   <br />
        //   //   <p>${article.content}</p>
        //   // </div>;
        //   // articlesDiv.innerHTML (articles)
        // } else {
        //   // there no articles yet! message, show loading
        //   articlesDiv.innerHTML = `<div>Loading...</div>`;
        // }
      };
    </script>
  </body>
  <script type="module" src="../scripts/home.js"></script>
</html>

<style type="text/css">
  body {
    background: yellow;
  }

  /* remove text underline in the `<a>` tag*/
  a {
    text-decoration: none;
    color: black
  }

  a:hover {
    border-bottom: 1px solid black  ;
  }

  /* class for hiding elements */
  .hide {
    display: none;
  }
</style>
